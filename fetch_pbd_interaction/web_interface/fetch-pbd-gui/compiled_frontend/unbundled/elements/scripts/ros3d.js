function setFrame(e,t){null===e.sn&&(e.sn=new ROS3D.SceneNode({frameID:t,tfClient:e.tfClient,object:e.ps}),e.rootObject.add(e.sn))}function finishedUpdate(e,t){null===e.first_size&&(e.first_size=t,e.max_pts=Math.max(e.max_pts,t));for(var o=t;o<e.prev_pts;o++)e.alpha[o]=0;if(e.prev_pts=t,e.geom.verticesNeedUpdate=!0,e.attribs.customColor.needsUpdate=!0,e.attribs.alpha.needsUpdate=!0,t>e.max_pts)throw"Attempted to draw more points than max_pts allows"}function read_point(e,t,o){for(var i=[],s=e.point_step*t,r=0;r<e.fields.length;r++){var n=s+e.fields[r].offset;"rgb"===e.fields[r].name?i.rgb=o.getInt32(n,1):i[e.fields[r].name]=o.getFloat32(n,1)}return i}function decode64(e){for(var t=[],o=0,i=0,s=0,r=e.length;s<r;s++)o+=BASE64.indexOf(e[s]),i+=6,i>=8&&(i-=8,t.push(o>>i),o&=Math.pow(2,i)-1),o<<=6;return t}var ROS3D=ROS3D||{REVISION:"0.17.0-SNAPSHOT"};ROS3D.MARKER_ARROW=0,ROS3D.MARKER_CUBE=1,ROS3D.MARKER_SPHERE=2,ROS3D.MARKER_CYLINDER=3,ROS3D.MARKER_LINE_STRIP=4,ROS3D.MARKER_LINE_LIST=5,ROS3D.MARKER_CUBE_LIST=6,ROS3D.MARKER_SPHERE_LIST=7,ROS3D.MARKER_POINTS=8,ROS3D.MARKER_TEXT_VIEW_FACING=9,ROS3D.MARKER_MESH_RESOURCE=10,ROS3D.MARKER_TRIANGLE_LIST=11,ROS3D.INTERACTIVE_MARKER_KEEP_ALIVE=0,ROS3D.INTERACTIVE_MARKER_POSE_UPDATE=1,ROS3D.INTERACTIVE_MARKER_MENU_SELECT=2,ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK=3,ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN=4,ROS3D.INTERACTIVE_MARKER_MOUSE_UP=5,ROS3D.INTERACTIVE_MARKER_NONE=0,ROS3D.INTERACTIVE_MARKER_MENU=1,ROS3D.INTERACTIVE_MARKER_BUTTON=2,ROS3D.INTERACTIVE_MARKER_MOVE_AXIS=3,ROS3D.INTERACTIVE_MARKER_MOVE_PLANE=4,ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS=5,ROS3D.INTERACTIVE_MARKER_MOVE_ROTATE=6,ROS3D.INTERACTIVE_MARKER_INHERIT=0,ROS3D.INTERACTIVE_MARKER_FIXED=1,ROS3D.INTERACTIVE_MARKER_VIEW_FACING=2,ROS3D.COLLADA_LOADER=1,ROS3D.COLLADA_LOADER_2=2,ROS3D.makeColorMaterial=function(e,t,o,i){var s=new THREE.Color;return s.setRGB(e,t,o),i<=.99?new THREE.MeshBasicMaterial({color:s.getHex(),opacity:i+.1,transparent:!0,depthWrite:!0,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,blendEquation:THREE.ReverseSubtractEquation,blending:THREE.NormalBlending}):new THREE.MeshPhongMaterial({color:s.getHex(),opacity:i,blending:THREE.NormalBlending})},ROS3D.intersectPlane=function(e,t,o){var i=new THREE.Vector3,s=new THREE.Vector3;i.subVectors(t,e.origin);var r=e.direction.dot(o);if(!(Math.abs(r)<e.precision)){var n=o.dot(i)/r;return s.addVectors(e.origin,e.direction.clone().multiplyScalar(n)),s}},ROS3D.findClosestPoint=function(e,t){var o=new THREE.Vector3;o.subVectors(e.origin,t.origin);var i=t.direction.clone(),s=e.direction.clone(),r=o.dot(i),n=i.dot(s),a=o.dot(s),c=i.dot(i),h=s.dot(s),l=h*c-n*n;if(!(Math.abs(l)<=1e-4)){return(r*n-a*c)/l}},ROS3D.closestAxisPoint=function(e,t,o){var i=new THREE.Projector,s=e.origin.clone();i.projectVector(s,t);var r=e.direction.clone().add(e.origin);i.projectVector(r,t);var n=r.clone().sub(s),a=new THREE.Vector2,c=a.subVectors(o,s).dot(n)/n.dot(n),h=new THREE.Vector2;h.addVectors(s,n.clone().multiplyScalar(c));var l=new THREE.Vector3(h.x,h.y,.5);i.unprojectVector(l,t);var p=new THREE.Ray(t.position,l.sub(t.position).normalize());return ROS3D.findClosestPoint(e,p)},ROS3D.DepthCloud=function(e){e=e||{},THREE.Object3D.call(this),this.url=e.url,this.streamType=e.streamType||"vp8",this.f=e.f||526,this.pointSize=e.pointSize||3,this.width=e.width||1024,this.height=e.height||1024,this.whiteness=e.whiteness||0,this.varianceThreshold=e.varianceThreshold||16667e-9;this.isMjpeg="mjpeg"===this.streamType.toLowerCase(),this.video=document.createElement(this.isMjpeg?"img":"video"),this.video.addEventListener(this.isMjpeg?"load":"loadedmetadata",this.metaLoaded.bind(this),!1),this.isMjpeg||(this.video.loop=!0),this.video.src=this.url,this.video.crossOrigin="Anonymous",this.video.setAttribute("crossorigin","Anonymous"),this.vertex_shader=["uniform sampler2D map;","","uniform float width;","uniform float height;","uniform float nearClipping, farClipping;","","uniform float pointSize;","uniform float zOffset;","","uniform float focallength;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","float sampleDepth(vec2 pos)","  {","    float depth;","    ","    vec2 vUv = vec2( pos.x / (width*2.0), pos.y / (height*2.0)+0.5 );","    vec2 vUv2 = vec2( pos.x / (width*2.0)+0.5, pos.y / (height*2.0)+0.5 );","    ","    vec4 depthColor = texture2D( map, vUv );","    ","    depth = ( depthColor.r + depthColor.g + depthColor.b ) / 3.0 ;","    ","    if (depth>0.99)","    {","      vec4 depthColor2 = texture2D( map, vUv2 );","      float depth2 = ( depthColor2.r + depthColor2.g + depthColor2.b ) / 3.0 ;","      depth = 0.99+depth2;","    }","    ","    return depth;","  }","","float median(float a, float b, float c)","  {","    float r=a;","    ","    if ( (a<b) && (b<c) )","    {","      r = b;","    }","    if ( (a<c) && (c<b) )","    {","      r = c;","    }","    return r;","  }","","float variance(float d1, float d2, float d3, float d4, float d5, float d6, float d7, float d8, float d9)","  {","    float mean = (d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9) / 9.0;","    float t1 = (d1-mean);","    float t2 = (d2-mean);","    float t3 = (d3-mean);","    float t4 = (d4-mean);","    float t5 = (d5-mean);","    float t6 = (d6-mean);","    float t7 = (d7-mean);","    float t8 = (d8-mean);","    float t9 = (d9-mean);","    float v = (t1*t1+t2*t2+t3*t3+t4*t4+t5*t5+t6*t6+t7*t7+t8*t8+t9*t9)/9.0;","    return v;","  }","","vec2 decodeDepth(vec2 pos)","  {","    vec2 ret;","    ","    ","    float depth1 = sampleDepth(vec2(position.x-1.0, position.y-1.0));","    float depth2 = sampleDepth(vec2(position.x, position.y-1.0));","    float depth3 = sampleDepth(vec2(position.x+1.0, position.y-1.0));","    float depth4 = sampleDepth(vec2(position.x-1.0, position.y));","    float depth5 = sampleDepth(vec2(position.x, position.y));","    float depth6 = sampleDepth(vec2(position.x+1.0, position.y));","    float depth7 = sampleDepth(vec2(position.x-1.0, position.y+1.0));","    float depth8 = sampleDepth(vec2(position.x, position.y+1.0));","    float depth9 = sampleDepth(vec2(position.x+1.0, position.y+1.0));","    ","    float median1 = median(depth1, depth2, depth3);","    float median2 = median(depth4, depth5, depth6);","    float median3 = median(depth7, depth8, depth9);","    ","    ret.x = median(median1, median2, median3);","    ret.y = variance(depth1, depth2, depth3, depth4, depth5, depth6, depth7, depth8, depth9);","    ","    return ret;","    ","  }","","","void main() {","  ","  vUvP = vec2( position.x / (width*2.0), position.y / (height*2.0)+0.5 );","  colorP = vec2( position.x / (width*2.0)+0.5 , position.y / (height*2.0)  );","  ","  vec4 pos = vec4(0.0,0.0,0.0,0.0);","  depthVariance = 0.0;","  ","  if ( (vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>0.0))","  {","    vec2 smp = decodeDepth(vec2(position.x, position.y));","    float depth = smp.x;","    depthVariance = smp.y;","    ","    float z = -depth;","    ","    pos = vec4(","      ( position.x / width - 0.5 ) * z * (1000.0/focallength) * -1.0,","      ( position.y / height - 0.5 ) * z * (1000.0/focallength),","      (- z + zOffset / 1000.0) * 2.0,","      1.0);","    ","    vec2 maskP = vec2( position.x / (width*2.0), position.y / (height*2.0)  );","    vec4 maskColor = texture2D( map, maskP );","    maskVal = ( maskColor.r + maskColor.g + maskColor.b ) / 3.0 ;","  }","  ","  gl_PointSize = pointSize;","  gl_Position = projectionMatrix * modelViewMatrix * pos;","  ","}"].join("\n"),this.fragment_shader=["uniform sampler2D map;","uniform float varianceThreshold;","uniform float whiteness;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","","void main() {","  ","  vec4 color;","  ","  if ( (depthVariance>varianceThreshold) || (maskVal>0.5) ||(vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>1.0))","  {  ","    discard;","  }","  else ","  {","    color = texture2D( map, colorP );","    ","    float fader = whiteness /100.0;","    ","    color.r = color.r * (1.0-fader)+ fader;","    ","    color.g = color.g * (1.0-fader)+ fader;","    ","    color.b = color.b * (1.0-fader)+ fader;","    ","    color.a = 1.0;//smoothstep( 20000.0, -20000.0, gl_FragCoord.z / gl_FragCoord.w );","  }","  ","  gl_FragColor = vec4( color.r, color.g, color.b, color.a );","  ","}"].join("\n")},ROS3D.DepthCloud.prototype.__proto__=THREE.Object3D.prototype,ROS3D.DepthCloud.prototype.metaLoaded=function(){this.metaLoaded=!0,this.initStreamer()},ROS3D.DepthCloud.prototype.initStreamer=function(){if(this.metaLoaded){this.texture=new THREE.Texture(this.video),this.geometry=new THREE.Geometry;for(var e=0,t=this.width*this.height;e<t;e++){var o=new THREE.Vector3;o.x=e%this.width,o.y=Math.floor(e/this.width),this.geometry.vertices.push(o)}this.material=new THREE.ShaderMaterial({uniforms:{map:{type:"t",value:this.texture},width:{type:"f",value:this.width},height:{type:"f",value:this.height},focallength:{type:"f",value:this.f},pointSize:{type:"f",value:this.pointSize},zOffset:{type:"f",value:0},whiteness:{type:"f",value:this.whiteness},varianceThreshold:{type:"f",value:this.varianceThreshold}},vertexShader:this.vertex_shader,fragmentShader:this.fragment_shader}),this.mesh=new THREE.ParticleSystem(this.geometry,this.material),this.mesh.position.x=0,this.mesh.position.y=0,this.add(this.mesh);var i=this;setInterval(function(){(i.isMjpeg||i.video.readyState===i.video.HAVE_ENOUGH_DATA)&&(i.texture.needsUpdate=!0)},1e3/30)}},ROS3D.DepthCloud.prototype.startStream=function(){this.isMjpeg||this.video.play()},ROS3D.DepthCloud.prototype.stopStream=function(){this.isMjpeg||this.video.pause()},ROS3D.InteractiveMarker=function(e){THREE.Object3D.call(this),THREE.EventDispatcher.call(this);var t=this;e=e||{};var o=e.handle;this.name=o.name;var i=e.camera,s=e.path||"/",r=e.loader||ROS3D.COLLADA_LOADER_2;this.dragging=!1,this.onServerSetPose({pose:o.pose}),this.dragStart={position:new THREE.Vector3,orientation:new THREE.Quaternion,positionWorld:new THREE.Vector3,orientationWorld:new THREE.Quaternion,event3d:{}},o.controls.forEach(function(e){t.add(new ROS3D.InteractiveMarkerControl({parent:t,handle:o,message:e,camera:i,path:s,loader:r}))}),o.menuEntries.length>0&&(this.menu=new ROS3D.InteractiveMarkerMenu({menuEntries:o.menuEntries,menuFontSize:o.menuFontSize}),this.menu.addEventListener("menu-select",function(e){t.dispatchEvent(e)}))},ROS3D.InteractiveMarker.prototype.__proto__=THREE.Object3D.prototype,ROS3D.InteractiveMarker.prototype.showMenu=function(e,t){this.menu&&this.menu.show(e,t)},ROS3D.InteractiveMarker.prototype.moveAxis=function(e,t,o){if(this.dragging){var i=e.currentControlOri,s=t.clone().applyQuaternion(i),r=this.dragStart.event3d.intersection.point,n=s.clone().applyQuaternion(this.dragStart.orientationWorld.clone()),a=new THREE.Ray(r,n),c=ROS3D.closestAxisPoint(a,o.camera,o.mousePos),h=new THREE.Vector3;h.addVectors(this.dragStart.position,s.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(c)),this.setPosition(e,h),o.stopPropagation()}},ROS3D.InteractiveMarker.prototype.movePlane=function(e,t,o){if(this.dragging){var i=e.currentControlOri,s=t.clone().applyQuaternion(i),r=this.dragStart.event3d.intersection.point,n=s.clone().applyQuaternion(this.dragStart.orientationWorld),a=ROS3D.intersectPlane(o.mouseRay,r,n),c=new THREE.Vector3;c.subVectors(a,r),c.add(this.dragStart.positionWorld),this.setPosition(e,c),o.stopPropagation()}},ROS3D.InteractiveMarker.prototype.rotateAxis=function(e,t,o){if(this.dragging){e.updateMatrixWorld();var i=e.currentControlOri,s=i.clone().multiply(t.clone()),r=new THREE.Vector3(1,0,0).applyQuaternion(s),n=this.dragStart.event3d.intersection.point,a=r.applyQuaternion(this.dragStart.orientationWorld),c=ROS3D.intersectPlane(o.mouseRay,n,a),h=new THREE.Ray(this.dragStart.positionWorld,a),l=ROS3D.intersectPlane(h,n,a),p=this.dragStart.orientationWorld.clone().multiply(s),d=p.clone().inverse();c.sub(l),c.applyQuaternion(d);var u=this.dragStart.event3d.intersection.point.clone();u.sub(l),u.applyQuaternion(d);var E=Math.atan2(c.y,c.z),R=Math.atan2(u.y,u.z),m=R-E,f=new THREE.Quaternion;f.setFromAxisAngle(r,m),this.setOrientation(e,f.multiply(this.dragStart.orientationWorld)),o.stopPropagation()}},ROS3D.InteractiveMarker.prototype.feedbackEvent=function(e,t){this.dispatchEvent({type:e,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:t.name})},ROS3D.InteractiveMarker.prototype.startDrag=function(e,t){if(0===t.domEvent.button){t.stopPropagation(),this.dragging=!0,this.updateMatrixWorld(!0);var o=new THREE.Vector3;this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,o),this.dragStart.position=this.position.clone(),this.dragStart.orientation=this.quaternion.clone(),this.dragStart.event3d=t,this.feedbackEvent("user-mousedown",e)}},ROS3D.InteractiveMarker.prototype.stopDrag=function(e,t){0===t.domEvent.button&&(t.stopPropagation(),this.dragging=!1,this.dragStart.event3d={},this.onServerSetPose(this.bufferedPoseEvent),this.bufferedPoseEvent=void 0,this.feedbackEvent("user-mouseup",e))},ROS3D.InteractiveMarker.prototype.buttonClick=function(e,t){t.stopPropagation(),this.feedbackEvent("user-button-click",e)},ROS3D.InteractiveMarker.prototype.setPosition=function(e,t){this.position=t,this.feedbackEvent("user-pose-change",e)},ROS3D.InteractiveMarker.prototype.setOrientation=function(e,t){t.normalize(),this.quaternion=t,this.feedbackEvent("user-pose-change",e)},ROS3D.InteractiveMarker.prototype.onServerSetPose=function(e){if(void 0!==e)if(this.dragging)this.bufferedPoseEvent=e;else{var t=e.pose;this.position.x=t.position.x,this.position.y=t.position.y,this.position.z=t.position.z,this.quaternion=new THREE.Quaternion(t.orientation.x,t.orientation.y,t.orientation.z,t.orientation.w),this.updateMatrixWorld(!0)}},ROS3D.InteractiveMarker.prototype.dispose=function(){var e=this;this.children.forEach(function(t){t.children.forEach(function(e){e.dispose(),t.remove(e)}),e.remove(t)})},THREE.EventDispatcher.prototype.apply(ROS3D.InteractiveMarker.prototype),ROS3D.InteractiveMarkerClient=function(e){e=e||{},this.ros=e.ros,this.tfClient=e.tfClient,this.topicName=e.topic,this.path=e.path||"/",this.camera=e.camera,this.rootObject=e.rootObject||new THREE.Object3D,this.loader=e.loader||ROS3D.COLLADA_LOADER_2,this.menuFontSize=e.menuFontSize||"0.8em",this.interactiveMarkers={},this.updateTopic=null,this.feedbackTopic=null,this.topicName&&this.subscribe(this.topicName)},ROS3D.InteractiveMarkerClient.prototype.subscribe=function(e){this.unsubscribe(),this.updateTopic=new ROSLIB.Topic({ros:this.ros,name:e+"/tunneled/update",messageType:"visualization_msgs/InteractiveMarkerUpdate",compression:"png"}),this.updateTopic.subscribe(this.processUpdate.bind(this)),this.feedbackTopic=new ROSLIB.Topic({ros:this.ros,name:e+"/feedback",messageType:"visualization_msgs/InteractiveMarkerFeedback",compression:"png"}),this.feedbackTopic.advertise(),this.initService=new ROSLIB.Service({ros:this.ros,name:e+"/tunneled/get_init",serviceType:"demo_interactive_markers/GetInit"});var t=new ROSLIB.ServiceRequest({});this.initService.callService(t,this.processInit.bind(this))},ROS3D.InteractiveMarkerClient.prototype.unsubscribe=function(){this.updateTopic&&this.updateTopic.unsubscribe(),this.feedbackTopic&&this.feedbackTopic.unadvertise();for(var e in this.interactiveMarkers)this.eraseIntMarker(e);this.interactiveMarkers={}},ROS3D.InteractiveMarkerClient.prototype.processInit=function(e){var t=e.msg;t.erases=[];for(var o in this.interactiveMarkers)t.erases.push(o);t.poses=[],this.processUpdate(t)},ROS3D.InteractiveMarkerClient.prototype.processUpdate=function(e){var t=this;e.erases.forEach(function(e){t.eraseIntMarker(e)}),e.poses.forEach(function(e){var o=t.interactiveMarkers[e.name];o&&o.setPoseFromServer(e.pose)}),e.markers.forEach(function(e){var o=t.interactiveMarkers[e.name];o&&t.eraseIntMarker(o.name);var i=new ROS3D.InteractiveMarkerHandle({message:e,feedbackTopic:t.feedbackTopic,tfClient:t.tfClient,menuFontSize:t.menuFontSize});t.interactiveMarkers[e.name]=i;var s=new ROS3D.InteractiveMarker({handle:i,camera:t.camera,path:t.path,loader:t.loader});s.name=e.name,t.rootObject.add(s),i.on("pose",function(e){s.onServerSetPose({pose:e})}),s.addEventListener("user-pose-change",i.setPoseFromClientBound),s.addEventListener("user-mousedown",i.onMouseDownBound),s.addEventListener("user-mouseup",i.onMouseUpBound),s.addEventListener("user-button-click",i.onButtonClickBound),s.addEventListener("menu-select",i.onMenuSelectBound),i.subscribeTf()})},ROS3D.InteractiveMarkerClient.prototype.eraseIntMarker=function(e){if(this.interactiveMarkers[e]){var t=this.rootObject.getObjectByName(e);this.rootObject.remove(t);var o=this.interactiveMarkers[e];o.unsubscribeTf(),t.removeEventListener("user-pose-change",o.setPoseFromClientBound),t.removeEventListener("user-mousedown",o.onMouseDownBound),t.removeEventListener("user-mouseup",o.onMouseUpBound),t.removeEventListener("user-button-click",o.onButtonClickBound),t.removeEventListener("menu-select",o.onMenuSelectBound),delete this.interactiveMarkers[e],t.dispose()}},ROS3D.InteractiveMarkerControl=function(e){function t(e){e.stopPropagation()}var o=this;THREE.Object3D.call(this),e=e||{},this.parent=e.parent;var i=e.handle,s=e.message;this.name=s.name,this.camera=e.camera,this.path=e.path||"/",this.loader=e.loader||ROS3D.COLLADA_LOADER_2,this.dragging=!1,this.startMousePos=new THREE.Vector2;var r=new THREE.Quaternion(s.orientation.x,s.orientation.y,s.orientation.z,s.orientation.w);r.normalize();var n=new THREE.Vector3(1,0,0);switch(n.applyQuaternion(r),this.currentControlOri=new THREE.Quaternion,s.interaction_mode){case ROS3D.INTERACTIVE_MARKER_MOVE_AXIS:this.addEventListener("mousemove",this.parent.moveAxis.bind(this.parent,this,n)),this.addEventListener("touchmove",this.parent.moveAxis.bind(this.parent,this,n));break;case ROS3D.INTERACTIVE_MARKER_ROTATE_AXIS:this.addEventListener("mousemove",this.parent.rotateAxis.bind(this.parent,this,r));break;case ROS3D.INTERACTIVE_MARKER_MOVE_PLANE:this.addEventListener("mousemove",this.parent.movePlane.bind(this.parent,this,n));break;case ROS3D.INTERACTIVE_MARKER_BUTTON:this.addEventListener("click",this.parent.buttonClick.bind(this.parent,this))}s.interaction_mode!==ROS3D.INTERACTIVE_MARKER_NONE&&(this.addEventListener("mousedown",this.parent.startDrag.bind(this.parent,this)),this.addEventListener("mouseup",this.parent.stopDrag.bind(this.parent,this)),this.addEventListener("contextmenu",this.parent.showMenu.bind(this.parent,this)),this.addEventListener("mouseup",function(e){0===o.startMousePos.distanceToSquared(e.mousePos)&&(e.type="contextmenu",o.dispatchEvent(e))}),this.addEventListener("mouseover",t),this.addEventListener("mouseout",t),this.addEventListener("click",t),this.addEventListener("mousedown",function(e){o.startMousePos=e.mousePos}),this.addEventListener("touchstart",function(e){1===e.domEvent.touches.length&&(e.type="mousedown",e.domEvent.button=0,o.dispatchEvent(e))}),this.addEventListener("touchmove",function(e){1===e.domEvent.touches.length&&(e.type="mousemove",e.domEvent.button=0,o.dispatchEvent(e))}),this.addEventListener("touchend",function(e){0===e.domEvent.touches.length&&(e.domEvent.button=0,e.type="mouseup",o.dispatchEvent(e),e.type="click",o.dispatchEvent(e))}));var a=new THREE.Quaternion,c=this.parent.position.clone().multiplyScalar(-1);switch(s.orientation_mode){case ROS3D.INTERACTIVE_MARKER_INHERIT:a=this.parent.quaternion.clone().inverse(),this.updateMatrixWorld=function(e){ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(o,e),o.currentControlOri.copy(o.quaternion),o.currentControlOri.normalize()};break;case ROS3D.INTERACTIVE_MARKER_FIXED:this.updateMatrixWorld=function(e){o.quaternion=o.parent.quaternion.clone().inverse(),o.updateMatrix(),o.matrixWorldNeedsUpdate=!0,ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(o,e),o.currentControlOri.copy(o.quaternion)};break;case ROS3D.INTERACTIVE_MARKER_VIEW_FACING:var h=s.independent_marker_orientation;this.updateMatrixWorld=function(e){o.camera.updateMatrixWorld();var t=(new THREE.Matrix4).extractRotation(o.camera.matrixWorld),i=new THREE.Matrix4,s=.5*Math.PI,r=new THREE.Euler(-s,0,s);i.makeRotationFromEuler(r);var n=new THREE.Matrix4;n.getInverse(o.parent.matrixWorld),t.multiplyMatrices(t,i),t.multiplyMatrices(n,t),o.currentControlOri.setFromRotationMatrix(t),h||(o.quaternion.copy(o.currentControlOri),o.updateMatrix(),o.matrixWorldNeedsUpdate=!0),ROS3D.InteractiveMarkerControl.prototype.updateMatrixWorld.call(o,e)};break;default:console.error("Unkown orientation mode: "+s.orientation_mode)}var l=new ROSLIB.TFClient({ros:i.tfClient.ros,fixedFrame:i.message.header.frame_id,serverName:i.tfClient.serverName});s.markers.forEach(function(e){var t=function(t){var i=new ROS3D.Marker({message:e,path:o.path,loader:o.loader});if(null!==t){var s=new ROSLIB.Pose({position:i.position,orientation:i.quaternion});s.applyTransform(new ROSLIB.Transform(t));var r=new ROS3D.Marker({message:e,path:o.path,loader:o.loader});r.position.add(c),r.position.applyQuaternion(a),r.quaternion.multiplyQuaternions(a,r.quaternion);var n=new THREE.Vector3(r.position.x,r.position.y,r.position.z),h=new ROSLIB.Transform({translation:n,orientation:r.quaternion});s.applyTransform(h),i.setPose(s),i.updateMatrixWorld(),l.unsubscribe(e.header.frame_id)}o.add(i)};""!==e.header.frame_id?l.subscribe(e.header.frame_id,t):t(null)})},ROS3D.InteractiveMarkerControl.prototype.__proto__=THREE.Object3D.prototype,ROS3D.InteractiveMarkerHandle=function(e){e=e||{},this.message=e.message,this.feedbackTopic=e.feedbackTopic,this.tfClient=e.tfClient,this.menuFontSize=e.menuFontSize||"0.8em",this.name=this.message.name,this.header=this.message.header,this.controls=this.message.controls,this.menuEntries=this.message.menu_entries,this.dragging=!1,this.timeoutHandle=null,this.tfTransform=new ROSLIB.Transform,this.pose=new ROSLIB.Pose,this.setPoseFromClientBound=this.setPoseFromClient.bind(this),this.onMouseDownBound=this.onMouseDown.bind(this),this.onMouseUpBound=this.onMouseUp.bind(this),this.onButtonClickBound=this.onButtonClick.bind(this),this.onMenuSelectBound=this.onMenuSelect.bind(this),this.setPoseFromServer(this.message.pose),this.tfUpdateBound=this.tfUpdate.bind(this)},ROS3D.InteractiveMarkerHandle.prototype.__proto__=EventEmitter2.prototype,ROS3D.InteractiveMarkerHandle.prototype.subscribeTf=function(){0===this.message.header.stamp.secs&&0===this.message.header.stamp.nsecs&&this.tfClient.subscribe(this.message.header.frame_id,this.tfUpdateBound)},ROS3D.InteractiveMarkerHandle.prototype.unsubscribeTf=function(){this.tfClient.unsubscribe(this.message.header.frame_id,this.tfUpdateBound)},ROS3D.InteractiveMarkerHandle.prototype.emitServerPoseUpdate=function(){var e=new ROSLIB.Pose(this.pose);e.applyTransform(this.tfTransform),this.emit("pose",e)},ROS3D.InteractiveMarkerHandle.prototype.setPoseFromServer=function(e){this.pose=new ROSLIB.Pose(e),this.emitServerPoseUpdate()},ROS3D.InteractiveMarkerHandle.prototype.tfUpdate=function(e){this.tfTransform=new ROSLIB.Transform(e),this.emitServerPoseUpdate()},ROS3D.InteractiveMarkerHandle.prototype.setPoseFromClient=function(e){this.pose=new ROSLIB.Pose(e);var t=this.tfTransform.clone();t.rotation.invert(),t.translation.multiplyQuaternion(t.rotation),t.translation.x*=-1,t.translation.y*=-1,t.translation.z*=-1,this.pose.applyTransform(t),this.sendFeedback(ROS3D.INTERACTIVE_MARKER_POSE_UPDATE,void 0,0,e.controlName),this.dragging&&(this.timeoutHandle&&clearTimeout(this.timeoutHandle),this.timeoutHandle=setTimeout(this.setPoseFromClient.bind(this,e),250))},ROS3D.InteractiveMarkerHandle.prototype.onButtonClick=function(e){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_BUTTON_CLICK,e.clickPosition,0,e.controlName)},ROS3D.InteractiveMarkerHandle.prototype.onMouseDown=function(e){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_DOWN,e.clickPosition,0,e.controlName),this.dragging=!0},ROS3D.InteractiveMarkerHandle.prototype.onMouseUp=function(e){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MOUSE_UP,e.clickPosition,0,e.controlName),this.dragging=!1,this.timeoutHandle&&clearTimeout(this.timeoutHandle)},ROS3D.InteractiveMarkerHandle.prototype.onMenuSelect=function(e){this.sendFeedback(ROS3D.INTERACTIVE_MARKER_MENU_SELECT,void 0,e.id,e.controlName)},ROS3D.InteractiveMarkerHandle.prototype.sendFeedback=function(e,t,o,i){var s=void 0!==t;t=t||{x:0,y:0,z:0};var r={header:this.header,client_id:this.clientID,marker_name:this.name,control_name:i,event_type:e,pose:this.pose,mouse_point:t,mouse_point_valid:s,menu_entry_id:o};this.feedbackTopic.publish(r)},ROS3D.InteractiveMarkerMenu=function(e){function t(e,t){this.dispatchEvent({type:"menu-select",domEvent:t,id:e.id,controlName:this.controlName}),this.hide(t)}function o(e,s){var r=document.createElement("ul");e.appendChild(r);for(var n=s.children,a=0;a<n.length;a++){var c=document.createElement("li"),h=document.createElement("div");h.appendChild(document.createTextNode(n[a].title)),r.appendChild(c),c.appendChild(h),n[a].children.length>0?(o(c,n[a]),h.addEventListener("click",i.hide.bind(i)),h.addEventListener("touchstart",i.hide.bind(i))):(h.addEventListener("click",t.bind(i,n[a])),h.addEventListener("touchstart",t.bind(i,n[a])),h.className="default-interactive-marker-menu-entry")}}var i=this;e=e||{};var s=e.menuEntries,r=e.className||"default-interactive-marker-menu",n=(e.entryClassName,e.overlayClassName||"default-interactive-marker-overlay"),a=e.menuFontSize||"0.8em",c=[];if(c[0]={children:[]},THREE.EventDispatcher.call(this),null===document.getElementById("default-interactive-marker-menu-css")){var h=document.createElement("style");h.id="default-interactive-marker-menu-css",h.type="text/css",h.innerHTML=".default-interactive-marker-menu {background-color: #444444;border: 1px solid #888888;border: 1px solid #888888;padding: 0px 0px 0px 0px;color: #FFFFFF;font-family: sans-serif;font-size: "+a+";z-index: 1002;}.default-interactive-marker-menu ul {padding: 0px 0px 5px 0px;margin: 0px;list-style-type: none;}.default-interactive-marker-menu ul li div {-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;cursor: default;padding: 3px 10px 3px 10px;}.default-interactive-marker-menu-entry:hover {  background-color: #666666;  cursor: pointer;}.default-interactive-marker-menu ul ul {  font-style: italic;  padding-left: 10px;}.default-interactive-marker-overlay {  position: absolute;  top: 0%;  left: 0%;  width: 100%;  height: 100%;  background-color: black;  z-index: 1001;  -moz-opacity: 0.0;  opacity: .0;  filter: alpha(opacity = 0);}",document.getElementsByTagName("head")[0].appendChild(h)}this.menuDomElem=document.createElement("div"),this.menuDomElem.style.position="absolute",this.menuDomElem.className=r,this.menuDomElem.addEventListener("contextmenu",function(e){e.preventDefault()}),this.overlayDomElem=document.createElement("div"),this.overlayDomElem.className=n,this.hideListener=this.hide.bind(this),this.overlayDomElem.addEventListener("contextmenu",this.hideListener),this.overlayDomElem.addEventListener("click",this.hideListener),this.overlayDomElem.addEventListener("touchstart",this.hideListener);var l,p,d;for(l=0;l<s.length;l++)p=s[l],d=p.id,c[d]={title:p.title,id:d,children:[]};for(l=0;l<s.length;l++){p=s[l],d=p.id;var u=c[d];c[p.parent_id].children.push(u)}o(this.menuDomElem,c[0])},ROS3D.InteractiveMarkerMenu.prototype.show=function(e,t){t&&t.preventDefault&&t.preventDefault(),this.controlName=e.name,void 0!==t.domEvent.changedTouches?(this.menuDomElem.style.left=t.domEvent.changedTouches[0].pageX+"px",this.menuDomElem.style.top=t.domEvent.changedTouches[0].pageY+"px"):(this.menuDomElem.style.left=t.domEvent.clientX+"px",this.menuDomElem.style.top=t.domEvent.clientY+"px"),document.body.appendChild(this.overlayDomElem),document.body.appendChild(this.menuDomElem)},ROS3D.InteractiveMarkerMenu.prototype.hide=function(e){e&&e.preventDefault&&e.preventDefault(),document.body.removeChild(this.overlayDomElem),document.body.removeChild(this.menuDomElem)},THREE.EventDispatcher.prototype.apply(ROS3D.InteractiveMarkerMenu.prototype),ROS3D.Marker=function(e){e=e||{};var t=e.path||"/",o=e.message,i=e.loader||ROS3D.COLLADA_LOADER_2;"/"!==t.substr(t.length-1)&&(t+="/"),THREE.Object3D.call(this),o.scale?this.msgScale=[o.scale.x,o.scale.y,o.scale.z]:this.msgScale=[1,1,1],this.msgColor=o.color,this.msgMesh=void 0,this.setPose(o.pose);var s=ROS3D.makeColorMaterial(this.msgColor.r,this.msgColor.g,this.msgColor.b,this.msgColor.a);switch(o.type){case ROS3D.MARKER_ARROW:var r,n=o.scale.x,a=.23*n,c=o.scale.y,h=.5*c,l=null;if(2===o.points.length){l=new THREE.Vector3(o.points[0].x,o.points[0].y,o.points[0].z);var p=new THREE.Vector3(o.points[1].x,o.points[1].y,o.points[1].z);r=l.clone().negate().add(p),n=r.length(),c=o.scale.y,h=o.scale.x,0!==o.scale.z&&(a=o.scale.z)}this.add(new ROS3D.Arrow({direction:r,origin:l,length:n,headLength:a,shaftDiameter:h,headDiameter:c,material:s}));break;case ROS3D.MARKER_CUBE:var d=new THREE.CubeGeometry(o.scale.x,o.scale.y,o.scale.z);this.add(new THREE.Mesh(d,s));break;case ROS3D.MARKER_SPHERE:var u=new THREE.SphereGeometry(.5),E=new THREE.Mesh(u,s);E.scale.x=o.scale.x,E.scale.y=o.scale.y,E.scale.z=o.scale.z,this.add(E);break;case ROS3D.MARKER_CYLINDER:var R=new THREE.CylinderGeometry(.5,.5,1,16,1,!1),m=new THREE.Mesh(R,s);m.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*Math.PI),m.scale=new THREE.Vector3(o.scale.x,o.scale.z,o.scale.y),this.add(m);break;case ROS3D.MARKER_LINE_STRIP:var f,v=new THREE.Geometry,T=new THREE.LineBasicMaterial({size:o.scale.x});for(f=0;f<o.points.length;f++){var O=new THREE.Vector3;O.x=o.points[f].x,O.y=o.points[f].y,O.z=o.points[f].z,v.vertices.push(O)}if(o.colors.length===o.points.length)for(T.vertexColors=!0,f=0;f<o.points.length;f++){var g=new THREE.Color;g.setRGB(o.colors[f].r,o.colors[f].g,o.colors[f].b),v.colors.push(g)}else T.color.setRGB(o.color.r,o.color.g,o.color.b);this.add(new THREE.Line(v,T));break;case ROS3D.MARKER_LINE_LIST:var b,y=new THREE.Geometry,S=new THREE.LineBasicMaterial({size:o.scale.x});for(b=0;b<o.points.length;b++){var D=new THREE.Vector3;D.x=o.points[b].x,D.y=o.points[b].y,D.z=o.points[b].z,y.vertices.push(D)}if(o.colors.length===o.points.length)for(S.vertexColors=!0,b=0;b<o.points.length;b++){var w=new THREE.Color;w.setRGB(o.colors[b].r,o.colors[b].g,o.colors[b].b),y.colors.push(w)}else S.color.setRGB(o.color.r,o.color.g,o.color.b);this.add(new THREE.Line(y,S,THREE.LinePieces));break;case ROS3D.MARKER_CUBE_LIST:var M,_,H,C,x=new THREE.Object3D,I=o.points.length,A=I===o.colors.length,k=Math.ceil(I/1250);for(M=0;M<I;M+=k)_=new THREE.CubeGeometry(o.scale.x,o.scale.y,o.scale.z),H=A?ROS3D.makeColorMaterial(o.colors[M].r,o.colors[M].g,o.colors[M].b,o.colors[M].a):s,C=new THREE.Mesh(_,H),C.position.x=o.points[M].x,C.position.y=o.points[M].y,C.position.z=o.points[M].z,x.add(C);this.add(x);break;case ROS3D.MARKER_SPHERE_LIST:var L,P,V,j,N=new THREE.Object3D,z=o.points.length,B=z===o.colors.length,U=Math.ceil(z/1250);for(L=0;L<z;L+=U)P=new THREE.SphereGeometry(.5,8,8),V=B?ROS3D.makeColorMaterial(o.colors[L].r,o.colors[L].g,o.colors[L].b,o.colors[L].a):s,j=new THREE.Mesh(P,V),j.scale.x=o.scale.x,j.scale.y=o.scale.y,j.scale.z=o.scale.z,j.position.x=o.points[L].x,j.position.y=o.points[L].y,j.position.z=o.points[L].z,N.add(j);this.add(N);break;case ROS3D.MARKER_POINTS:var K,F=new THREE.Geometry,G=new THREE.ParticleBasicMaterial({size:o.scale.x});for(K=0;K<o.points.length;K++){var W=new THREE.Vector3;W.x=o.points[K].x,W.y=o.points[K].y,W.z=o.points[K].z,F.vertices.push(W)}if(o.colors.length===o.points.length)for(G.vertexColors=!0,K=0;K<o.points.length;K++){var q=new THREE.Color;q.setRGB(o.colors[K].r,o.colors[K].g,o.colors[K].b),
F.colors.push(q)}else G.color.setRGB(o.color.r,o.color.g,o.color.b);this.add(new THREE.ParticleSystem(F,G));break;case ROS3D.MARKER_TEXT_VIEW_FACING:if(o.text.length>0){var Q=this.msgColor,X=document.createElement("canvas"),Y=X.getContext("2d");Y.font="normal 100px sans-serif";var Z=Y.measureText(o.text),J=Z.width;X.width=J,X.height=150,Y.font="normal 100px sans-serif",Y.fillStyle="rgba("+Q.r+", "+Q.g+", "+Q.b+", "+Q.a+")",Y.textAlign="left",Y.textBaseline="middle",Y.fillText(o.text,0,X.height/2);var $=new THREE.Texture(X);$.needsUpdate=!0;var ee=new THREE.SpriteMaterial({map:$,useScreenCoordinates:!1}),te=new THREE.Sprite(ee),oe=o.scale.x;te.scale.set(J/X.height*oe,oe,1),this.add(te)}break;case ROS3D.MARKER_MESH_RESOURCE:var ie=null;0===o.color.r&&0===o.color.g&&0===o.color.b&&0===o.color.a||(ie=s),this.msgMesh=o.mesh_resource.substr(10);var se=new ROS3D.MeshResource({path:t,resource:this.msgMesh,material:ie,loader:i});this.add(se);break;case ROS3D.MARKER_TRIANGLE_LIST:var re=new ROS3D.TriangleList({material:s,vertices:o.points,colors:o.colors});re.scale=new THREE.Vector3(o.scale.x,o.scale.y,o.scale.z),this.add(re);break;default:console.error("Currently unsupported marker type: "+o.type)}},ROS3D.Marker.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Marker.prototype.setPose=function(e){this.position.x=e.position.x,this.position.y=e.position.y,this.position.z=e.position.z,this.quaternion=new THREE.Quaternion(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),this.quaternion.normalize(),this.updateMatrixWorld()},ROS3D.Marker.prototype.update=function(e){if(this.setPose(e.pose),e.color.r!==this.msgColor.r||e.color.g!==this.msgColor.g||e.color.b!==this.msgColor.b||e.color.a!==this.msgColor.a){var t=ROS3D.makeColorMaterial(e.color.r,e.color.g,e.color.b,e.color.a);switch(e.type){case ROS3D.MARKER_LINE_STRIP:case ROS3D.MARKER_LINE_LIST:case ROS3D.MARKER_POINTS:break;case ROS3D.MARKER_ARROW:case ROS3D.MARKER_CUBE:case ROS3D.MARKER_SPHERE:case ROS3D.MARKER_CYLINDER:case ROS3D.MARKER_TRIANGLE_LIST:case ROS3D.MARKER_TEXT_VIEW_FACING:this.traverse(function(e){e instanceof THREE.Mesh&&(e.material=t)});break;case ROS3D.MARKER_MESH_RESOURCE:var o=null;0===e.color.r&&0===e.color.g&&0===e.color.b&&0===e.color.a||(o=this.colorMaterial),this.traverse(function(e){e instanceof THREE.Mesh&&(e.material=o)});break;case ROS3D.MARKER_CUBE_LIST:case ROS3D.MARKER_SPHERE_LIST:default:return!1}this.msgColor=e.color}var i=Math.abs(this.msgScale[0]-e.scale.x)>1e-6||Math.abs(this.msgScale[1]-e.scale.y)>1e-6||Math.abs(this.msgScale[2]-e.scale.z)>1e-6;switch(this.msgScale=[e.scale.x,e.scale.y,e.scale.z],e.type){case ROS3D.MARKER_CUBE:case ROS3D.MARKER_SPHERE:case ROS3D.MARKER_CYLINDER:if(i)return!1;break;case ROS3D.MARKER_TEXT_VIEW_FACING:if(i||this.text!==e.text)return!1;break;case ROS3D.MARKER_MESH_RESOURCE:if(e.mesh_resource.substr(10)!==this.msgMesh)return!1;if(i)return!1;break;case ROS3D.MARKER_ARROW:case ROS3D.MARKER_LINE_STRIP:case ROS3D.MARKER_LINE_LIST:case ROS3D.MARKER_CUBE_LIST:case ROS3D.MARKER_SPHERE_LIST:case ROS3D.MARKER_POINTS:case ROS3D.MARKER_TRIANGLE_LIST:return!1}return!0},ROS3D.Marker.prototype.dispose=function(){this.children.forEach(function(e){e instanceof ROS3D.MeshResource?e.children.forEach(function(t){void 0!==t.material&&t.material.dispose(),t.children.forEach(function(e){void 0!==e.geometry&&e.geometry.dispose(),void 0!==e.material&&e.material.dispose(),t.remove(e)}),e.remove(t)}):(void 0!==e.geometry&&e.geometry.dispose(),void 0!==e.material&&e.material.dispose()),e.parent.remove(e)})},ROS3D.MarkerArrayClient=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new THREE.Object3D,this.path=e.path||"/",this.loader=e.loader||ROS3D.COLLADA_LOADER_2,this.markers={},this.rosTopic=void 0,this.subscribe()},ROS3D.MarkerArrayClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.MarkerArrayClient.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"visualization_msgs/MarkerArray",compression:"png"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.MarkerArrayClient.prototype.processMessage=function(e){e.markers.forEach(function(e){if(0===e.action){var t=!1;if(e.ns+e.id in this.markers&&((t=this.markers[e.ns+e.id].children[0].update(e))||(this.markers[e.ns+e.id].unsubscribeTf(),this.rootObject.remove(this.markers[e.ns+e.id]))),!t){var o=new ROS3D.Marker({message:e,path:this.path,loader:this.loader});this.markers[e.ns+e.id]=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:o}),this.rootObject.add(this.markers[e.ns+e.id])}}else if(1===e.action)console.warn('Received marker message with deprecated action identifier "1"');else if(2===e.action)this.markers[e.ns+e.id]&&(this.markers[e.ns+e.id].unsubscribeTf(),this.rootObject.remove(this.markers[e.ns+e.id]),delete this.markers[e.ns+e.id]);else if(3===e.action){for(var i in this.markers)this.markers[i].unsubscribeTf(),this.rootObject.remove(this.markers[i]);this.markers={}}else console.warn('Received marker message with unknown action identifier "'+e.action+'"')}.bind(this)),this.emit("change")},ROS3D.MarkerArrayClient.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.MarkerClient=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new THREE.Object3D,this.path=e.path||"/",this.loader=e.loader||ROS3D.COLLADA_LOADER_2,this.markers={},this.rosTopic=void 0,this.subscribe()},ROS3D.MarkerClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.MarkerClient.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.MarkerClient.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"visualization_msgs/Marker",compression:"png"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.MarkerClient.prototype.processMessage=function(e){var t=new ROS3D.Marker({message:e,path:this.path,loader:this.loader}),o=this.markers[e.ns+e.id];o&&(o.unsubscribeTf(),this.rootObject.remove(o)),this.markers[e.ns+e.id]=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:t}),this.rootObject.add(this.markers[e.ns+e.id]),this.emit("change")},ROS3D.Arrow=function(e){e=e||{};var t=e.origin||new THREE.Vector3(0,0,0),o=e.direction||new THREE.Vector3(1,0,0),i=e.length||1,s=e.headLength||.2,r=e.shaftDiameter||.05,n=e.headDiameter||.1,a=e.material||new THREE.MeshBasicMaterial,c=i-s,h=new THREE.CylinderGeometry(.5*r,.5*r,c,12,1),l=new THREE.Matrix4;l.setPosition(new THREE.Vector3(0,.5*c,0)),h.applyMatrix(l);var p=new THREE.CylinderGeometry(0,.5*n,s,12,1);l.setPosition(new THREE.Vector3(0,c+.5*s,0)),p.applyMatrix(l),THREE.GeometryUtils.merge(h,p),THREE.Mesh.call(this,h,a),this.position=t,this.setDirection(o)},ROS3D.Arrow.prototype.__proto__=THREE.Mesh.prototype,ROS3D.Arrow.prototype.setDirection=function(e){var t=new THREE.Vector3(0,1,0).cross(e),o=Math.acos(new THREE.Vector3(0,1,0).dot(e.clone().normalize()));this.matrix=(new THREE.Matrix4).makeRotationAxis(t.normalize(),o),this.rotation.setFromRotationMatrix(this.matrix,this.rotation.order)},ROS3D.Arrow.prototype.setLength=function(e){this.scale.set(e,e,e)},ROS3D.Arrow.prototype.setColor=function(e){this.material.color.setHex(e)},ROS3D.Axes=function(e){function t(e){var t=new THREE.Color;t.setRGB(e.x,e.y,e.z);var i=new THREE.MeshBasicMaterial({color:t.getHex()}),s=new THREE.Vector3;s.crossVectors(e,new THREE.Vector3(0,-1,0));var r=new THREE.Quaternion;r.setFromAxisAngle(s,.5*Math.PI);var n=new THREE.Mesh(o.headGeom,i);n.position=e.clone(),n.position.multiplyScalar(.95),n.quaternion=r,n.updateMatrix(),o.add(n);var a=new THREE.Mesh(o.lineGeom,i);a.position=e.clone(),a.position.multiplyScalar(.45),a.quaternion=r,a.updateMatrix(),o.add(a)}var o=this;e=e||{};var i=e.shaftRadius||.008,s=e.headRadius||.023,r=e.headLength||.1;THREE.Object3D.call(this),this.lineGeom=new THREE.CylinderGeometry(i,i,1-r),this.headGeom=new THREE.CylinderGeometry(0,s,r),t(new THREE.Vector3(1,0,0)),t(new THREE.Vector3(0,1,0)),t(new THREE.Vector3(0,0,1))},ROS3D.Axes.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Grid=function(e){e=e||{};var t=e.num_cells||10,o=e.color||"#cccccc",i=e.lineWidth||1,s=e.cellSize||1;THREE.Object3D.call(this);for(var r=new THREE.LineBasicMaterial({color:o,linewidth:i}),n=0;n<=t;++n){var a=s*t/2,c=a-n*s,h=new THREE.Geometry;h.vertices.push(new THREE.Vector3(-a,c,0),new THREE.Vector3(a,c,0));var l=new THREE.Geometry;l.vertices.push(new THREE.Vector3(c,-a,0),new THREE.Vector3(c,a,0)),this.add(new THREE.Line(h,r)),this.add(new THREE.Line(l,r))}},ROS3D.Grid.prototype.__proto__=THREE.Object3D.prototype,ROS3D.MeshResource=function(e){var t=this;e=e||{};var o=e.path||"/",i=e.resource,s=e.material||null;this.warnings=e.warnings;var r=e.loader||ROS3D.COLLADA_LOADER_2;THREE.Object3D.call(this),"/"!==o.substr(o.length-1)&&(this.path+="/");var n,a=o+i,c=a.substr(-4).toLowerCase();".dae"===c?(n=r===ROS3D.COLLADA_LOADER?new THREE.ColladaLoader:new ColladaLoader2,n.log=function(e){t.warnings&&console.warn(e)},n.load(a,function(e){if(r===ROS3D.COLLADA_LOADER_2&&e.dae.asset.unit){var o=e.dae.asset.unit;e.scene.scale=new THREE.Vector3(o,o,o)}if(null!==s){var i=function(e,t){if(void 0===e.material&&(e.material=t),e.children)for(var o=0;o<e.children.length;o++)i(e.children[o],t)};i(e.scene,s)}t.add(e.scene)})):".stl"===c&&(n=new THREE.STLLoader,n.load(a,function(e){e.computeFaceNormals();var o;o=null!==s?new THREE.Mesh(e,s):new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:10066329})),t.add(o)}))},ROS3D.MeshResource.prototype.__proto__=THREE.Object3D.prototype,ROS3D.TriangleList=function(e){e=e||{};var t=e.material||new THREE.MeshBasicMaterial,o=e.vertices,i=e.colors;THREE.Object3D.call(this),t.side=THREE.DoubleSide;var s=new THREE.Geometry;for(r=0;r<o.length;r++)s.vertices.push(new THREE.Vector3(o[r].x,o[r].y,o[r].z));var r,n;if(i.length===o.length){for(r=0;r<o.length;r+=3){var a=new THREE.Face3(r,r+1,r+2);for(n=3*r;n<3*r+3;r++){var c=new THREE.Color;c.setRGB(i[r].r,i[r].g,i[r].b),a.vertexColors.push(c)}s.faces.push(a)}t.vertexColors=THREE.VertexColors}else if(i.length===o.length/3){for(r=0;r<o.length;r+=3){var h=new THREE.Face3(r,r+1,r+2);h.color.setRGB(i[r/3].r,i[r/3].g,i[r/3].b),s.faces.push(h)}t.vertexColors=THREE.FaceColors}else for(r=0;r<o.length;r+=3){var l=new THREE.Face3(r,r+1,r+2);s.faces.push(l)}s.computeBoundingBox(),s.computeBoundingSphere(),s.computeCentroids(),s.computeFaceNormals(),this.add(new THREE.Mesh(s,t))},ROS3D.TriangleList.prototype.__proto__=THREE.Object3D.prototype,ROS3D.TriangleList.prototype.setColor=function(e){this.mesh.material.color.setHex(e)},ROS3D.OccupancyGrid=function(e){e=e||{};var t=e.message,o=e.color||{r:255,g:255,b:255},i=e.opacity||1,s=t.info.width,r=t.info.height,n=new THREE.PlaneGeometry(s,r),a=document.createElement("canvas");a.width=s,a.height=r;for(var c=a.getContext("2d"),h=c.createImageData(s,r),l=0;l<r;l++)for(var p=0;p<s;p++){var d,u=p+(r-l-1)*s,E=t.data[u];d=100===E?0:0===E?255:127;var R=4*(p+l*s);h.data[R]=d*o.r/255,h.data[++R]=d*o.g/255,h.data[++R]=d*o.b/255,h.data[++R]=255}c.putImageData(h,0,0);var m=new THREE.Texture(a);m.needsUpdate=!0;var f=new THREE.MeshBasicMaterial({map:m,transparent:i<1,opacity:i});f.side=THREE.DoubleSide,THREE.Mesh.call(this,n,f),this.quaternion=new THREE.Quaternion(t.info.origin.orientation.x,t.info.origin.orientation.y,t.info.origin.orientation.z,t.info.origin.orientation.w),this.position.x=s*t.info.resolution/2+t.info.origin.position.x,this.position.y=r*t.info.resolution/2+t.info.origin.position.y,this.position.z=t.info.origin.position.z,this.scale.x=t.info.resolution,this.scale.y=t.info.resolution},ROS3D.OccupancyGrid.prototype.__proto__=THREE.Mesh.prototype,ROS3D.OccupancyGridClient=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic||"/map",this.continuous=e.continuous,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new THREE.Object3D,this.offsetPose=e.offsetPose||new ROSLIB.Pose,this.color=e.color||{r:255,g:255,b:255},this.opacity=e.opacity||1,this.currentGrid=null,this.rosTopic=void 0,this.subscribe()},ROS3D.OccupancyGridClient.prototype.__proto__=EventEmitter2.prototype,ROS3D.OccupancyGridClient.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.OccupancyGridClient.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"nav_msgs/OccupancyGrid",compression:"png"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.OccupancyGridClient.prototype.processMessage=function(e){this.currentGrid&&(this.currentGrid.tfClient&&this.currentGrid.unsubscribeTf(),this.rootObject.remove(this.currentGrid));var t=new ROS3D.OccupancyGrid({message:e,color:this.color,opacity:this.opacity});this.tfClient?this.currentGrid=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:t,pose:this.offsetPose}):this.currentGrid=t,this.rootObject.add(this.currentGrid),this.emit("change"),this.continuous||this.rosTopic.unsubscribe()},ROS3D.Odometry=function(e){this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/particlecloud",this.tfClient=e.tfClient,this.color=e.color||13369599,this.length=e.length||1,this.rootObject=e.rootObject||new THREE.Object3D,this.keep=e.keep||1,THREE.Object3D.call(this),this.sns=[],this.rosTopic=void 0,this.subscribe()},ROS3D.Odometry.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Odometry.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.Odometry.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"nav_msgs/Odometry"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.Odometry.prototype.processMessage=function(e){this.sns.length>=this.keep&&(this.sns[0].unsubscribeTf(),this.rootObject.remove(this.sns[0]),this.sns.shift()),this.options.origin=new THREE.Vector3(e.pose.pose.position.x,e.pose.pose.position.y,e.pose.pose.position.z);var t=new THREE.Quaternion(e.pose.pose.orientation.x,e.pose.pose.orientation.y,e.pose.pose.orientation.z,e.pose.pose.orientation.w);this.options.direction=new THREE.Vector3(1,0,0),this.options.direction.applyQuaternion(t),this.options.material=new THREE.MeshBasicMaterial({color:this.color});var o=new ROS3D.Arrow(this.options);this.sns.push(new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:o})),this.rootObject.add(this.sns[this.sns.length-1])},ROS3D.Path=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic||"/path",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new THREE.Object3D,THREE.Object3D.call(this),this.sn=null,this.line=null,this.rosTopic=void 0,this.subscribe()},ROS3D.Path.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Path.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.Path.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"nav_msgs/Path"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.Path.prototype.processMessage=function(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));for(var t=new THREE.Geometry,o=0;o<e.poses.length;o++){var i=new THREE.Vector3(e.poses[o].pose.position.x,e.poses[o].pose.position.y,e.poses[o].pose.position.z);t.vertices.push(i)}t.computeLineDistances();var s=new THREE.LineBasicMaterial({color:this.color}),r=new THREE.Line(t,s);this.sn=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:r}),this.rootObject.add(this.sn)},ROS3D.Point=function(e){this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/point",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new THREE.Object3D,this.radius=e.radius||.2,THREE.Object3D.call(this),this.sn=null,this.rosTopic=void 0,this.subscribe()},ROS3D.Point.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Point.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.Point.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"geometry_msgs/PointStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.Point.prototype.processMessage=function(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));var t=new THREE.SphereGeometry(this.radius),o=new THREE.MeshBasicMaterial({color:this.color}),i=new THREE.Mesh(t,o);i.position.set(e.point.x,e.point.y,e.point.z),this.sn=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:i}),this.rootObject.add(this.sn)},ROS3D.Polygon=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic||"/path",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new THREE.Object3D,THREE.Object3D.call(this),this.sn=null,this.line=null,this.rosTopic=void 0,this.subscribe()},ROS3D.Polygon.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Polygon.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.Polygon.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"geometry_msgs/PolygonStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.Polygon.prototype.processMessage=function(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));for(var t,o=new THREE.Geometry,i=0;i<e.polygon.points.length;i++)t=new THREE.Vector3(e.polygon.points[i].x,e.polygon.points[i].y,e.polygon.points[i].z),o.vertices.push(t);t=new THREE.Vector3(e.polygon.points[0].x,e.polygon.points[0].y,e.polygon.points[0].z),o.vertices.push(t),o.computeLineDistances();var s=new THREE.LineBasicMaterial({color:this.color}),r=new THREE.Line(o,s);this.sn=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:r}),this.rootObject.add(this.sn)},ROS3D.Pose=function(e){this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/pose",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new THREE.Object3D,THREE.Object3D.call(this),this.sn=null,this.rosTopic=void 0,this.subscribe()},ROS3D.Pose.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Pose.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.Pose.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"geometry_msgs/PoseStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.Pose.prototype.processMessage=function(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn)),this.options.origin=new THREE.Vector3(e.pose.position.x,e.pose.position.y,e.pose.position.z);var t=new THREE.Quaternion(e.pose.orientation.x,e.pose.orientation.y,e.pose.orientation.z,e.pose.orientation.w);this.options.direction=new THREE.Vector3(1,0,0),this.options.direction.applyQuaternion(t),this.options.material=new THREE.MeshBasicMaterial({color:this.color});var o=new ROS3D.Arrow(this.options);this.sn=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:o}),this.rootObject.add(this.sn)},ROS3D.PoseArray=function(e){this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/particlecloud",this.tfClient=e.tfClient,this.color=e.color||13369599,this.length=e.length||1,this.rootObject=e.rootObject||new THREE.Object3D,THREE.Object3D.call(this),this.sn=null,this.rosTopic=void 0,this.subscribe()},ROS3D.PoseArray.prototype.__proto__=THREE.Object3D.prototype,ROS3D.PoseArray.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.PoseArray.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"geometry_msgs/PoseArray"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.PoseArray.prototype.processMessage=function(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));for(var t,o=new THREE.Object3D,i=0;i<e.poses.length;i++){var s=new THREE.Geometry,r=new THREE.Vector3(e.poses[i].position.x,e.poses[i].position.y,e.poses[i].position.z);s.vertices.push(r);var n=new THREE.Quaternion(e.poses[i].orientation.x,e.poses[i].orientation.y,e.poses[i].orientation.z,e.poses[i].orientation.w),a=new THREE.Vector3(this.length,0,0),c=new THREE.Vector3(.8*this.length,.2*this.length,0),h=new THREE.Vector3(.8*this.length,.2*-this.length,0);a.applyQuaternion(n),c.applyQuaternion(n),h.applyQuaternion(n),s.vertices.push(a.add(r)),s.vertices.push(c.add(r)),s.vertices.push(h.add(r)),s.vertices.push(a),s.computeLineDistances();var l=new THREE.LineBasicMaterial({color:this.color});t=new THREE.Line(s,l),o.add(t)}this.sn=new ROS3D.SceneNode({frameID:e.header.frame_id,tfClient:this.tfClient,object:o}),this.rootObject.add(this.sn)},ROS3D.LaserScan=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic||"/scan",this.color=e.color||16753920,this.particles=new ROS3D.Particles(e),this.rosTopic=void 0,this.subscribe()},ROS3D.LaserScan.prototype.__proto__=THREE.Object3D.prototype,ROS3D.LaserScan.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.LaserScan.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"sensor_msgs/LaserScan"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.LaserScan.prototype.processMessage=function(e){setFrame(this.particles,e.header.frame_id);for(var t=e.ranges.length,o=0;o<t;o++){var i=e.ranges[o];if(i<e.range_min||i>e.range_max)this.particles.alpha[o]=0;else{var s=e.angle_min+o*e.angle_increment;this.particles.points[o]=new THREE.Vector3(i*Math.cos(s),i*Math.sin(s),0),this.particles.alpha[o]=1}this.particles.colors[o]=new THREE.Color(this.color)}finishedUpdate(this.particles,t)},ROS3D.Particles=function(e){e=e||{},this.tfClient=e.tfClient;var t=e.texture||"https://upload.wikimedia.org/wikipedia/commons/a/a2/Pixel-white.png",o=e.size||.05;this.max_pts=e.max_pts||1e4,this.first_size=null,this.prev_pts=0,this.rootObject=e.rootObject||new THREE.Object3D;THREE.Object3D.call(this),this.vertex_shader=["attribute vec3 customColor;","attribute float alpha;","varying vec3 vColor;","varying float falpha;","void main() ","{","    vColor = customColor; // set color associated to vertex; use later in fragment shader","    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    falpha = alpha; ","","    // option (1): draw particles at constant size on screen","    // gl_PointSize = size;","    // option (2): scale particles as objects in 3D space","    gl_PointSize = ",o,"* ( 300.0 / length( mvPosition.xyz ) );","    gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),this.fragment_shader=["uniform sampler2D texture;","varying vec3 vColor; // colors associated to vertices; assigned by vertex shader","varying float falpha;","void main() ","{","    // THREE.Material.alphaTest is not evaluated for ShaderMaterial, so we","    // have to take care of this ourselves.","    if (falpha < 0.5) discard;","    // calculates a color for the particle","    gl_FragColor = vec4( vColor, falpha );","    // sets particle texture to desired color","    gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );","}"].join("\n"),this.geom=new THREE.Geometry;for(var i=0;i<this.max_pts;i++)this.geom.vertices.push(new THREE.Vector3);var s={texture:{type:"t",value:THREE.ImageUtils.loadTexture(t)}};this.attribs={customColor:{type:"c",value:[]},alpha:{type:"f",value:[]}},this.shaderMaterial=new THREE.ShaderMaterial({uniforms:s,attributes:this.attribs,vertexShader:this.vertex_shader,fragmentShader:this.fragment_shader,transparent:!0}),this.ps=new THREE.ParticleSystem(this.geom,this.shaderMaterial),this.sn=null,this.points=this.geom.vertices,this.colors=this.attribs.customColor.value,this.alpha=this.attribs.alpha.value};var BASE64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";ROS3D.PointCloud2=function(e){e=e||{},this.ros=e.ros,this.topicName=e.topic||"/points",this.particles=new ROS3D.Particles(e),this.rosTopic=void 0,this.subscribe()},ROS3D.PointCloud2.prototype.__proto__=THREE.Object3D.prototype,ROS3D.PointCloud2.prototype.unsubscribe=function(){this.rosTopic&&this.rosTopic.unsubscribe()},ROS3D.PointCloud2.prototype.subscribe=function(){this.unsubscribe(),this.rosTopic=new ROSLIB.Topic({ros:this.ros,name:this.topicName,messageType:"sensor_msgs/PointCloud2"}),this.rosTopic.subscribe(this.processMessage.bind(this))},ROS3D.PointCloud2.prototype.processMessage=function(e){setFrame(this.particles,e.header.frame_id);var t,o=e.height*e.width;t=e.data.buffer?e.data.buffer.buffer:Uint8Array.from(decode64(e.data)).buffer;for(var i=new DataView(t),s=0;s<o;s++){var r=read_point(e,s,i);this.particles.points[s]=new THREE.Vector3(r.x,r.y,r.z),this.particles.colors[s]=new THREE.Color(r.rgb),this.particles.alpha[s]=1}finishedUpdate(this.particles,o)},ROS3D.Urdf=function(e){e=e||{};var t=e.urdfModel,o=e.path||"/",i=e.tfClient,s=e.tfPrefix||"",r=e.loader||ROS3D.COLLADA_LOADER_2;THREE.Object3D.call(this);var n=t.links;for(var a in n)for(var c=n[a],h=0;h<c.visuals.length;h++){var l=c.visuals[h];if(l&&l.geometry){var p=s+"/"+c.name,d=null;if(l.material&&l.material.color){var u=l.material&&l.material.color;d=ROS3D.makeColorMaterial(u.r,u.g,u.b,u.a)}if(l.geometry.type===ROSLIB.URDF_MESH){var E=l.geometry.filename,R=E.indexOf("package://");-1!==R&&(E=E.substr(R+"package://".length));var m=E.substr(-4).toLowerCase();if(".dae"===m||".stl"===m){var f=new ROS3D.MeshResource({path:o,resource:E,loader:r,material:d});c.visuals[h].geometry.scale&&(f.scale=new THREE.Vector3(l.geometry.scale.x,l.geometry.scale.y,l.geometry.scale.z));var v=new ROS3D.SceneNode({frameID:p,pose:l.origin,tfClient:i,object:f});this.add(v)}else console.warn("Could not load geometry mesh: "+E)}else{d||(d=ROS3D.makeColorMaterial(0,0,0,1));var T;switch(l.geometry.type){case ROSLIB.URDF_BOX:var O=l.geometry.dimension,g=new THREE.CubeGeometry(O.x,O.y,O.z);T=new THREE.Mesh(g,d);break;case ROSLIB.URDF_CYLINDER:var b=l.geometry.radius,y=l.geometry.length,S=new THREE.CylinderGeometry(b,b,y,16,1,!1);T=new THREE.Mesh(S,d),T.quaternion.setFromAxisAngle(new THREE.Vector3(1,0,0),.5*Math.PI);break;case ROSLIB.URDF_SPHERE:var D=new THREE.SphereGeometry(l.geometry.radius,16);T=new THREE.Mesh(D,d)}var w=new ROS3D.SceneNode({frameID:p,pose:l.origin,tfClient:i,object:T});this.add(w)}}}},ROS3D.Urdf.prototype.__proto__=THREE.Object3D.prototype,ROS3D.Urdf.prototype.unsubscribeTf=function(){this.children.forEach(function(e){"function"==typeof e.unsubscribeTf&&e.unsubscribeTf()})},ROS3D.UrdfClient=function(e){var t=this;e=e||{};var o=e.ros;this.param=e.param||"robot_description",this.path=e.path||"/",this.tfClient=e.tfClient,this.rootObject=e.rootObject||new THREE.Object3D,this.tfPrefix=e.tfPrefix||"",this.loader=e.loader||ROS3D.COLLADA_LOADER_2,new ROSLIB.Param({ros:o,name:this.param}).get(function(e){var o=new ROSLIB.UrdfModel({string:e});t.urdf=new ROS3D.Urdf({urdfModel:o,path:t.path,tfClient:t.tfClient,tfPrefix:t.tfPrefix,loader:t.loader}),t.rootObject.add(t.urdf)})},ROS3D.SceneNode=function(e){e=e||{};var t=this;this.tfClient=e.tfClient,this.frameID=e.frameID;var o=e.object;this.pose=e.pose||new ROSLIB.Pose,THREE.Object3D.call(this),this.visible=!1,this.add(o),this.updatePose(this.pose),this.tfUpdate=function(e){var o=new ROSLIB.Transform(e),i=new ROSLIB.Pose(t.pose);i.applyTransform(o),t.updatePose(i),t.visible=!0},this.tfClient.subscribe(this.frameID,this.tfUpdate)},ROS3D.SceneNode.prototype.__proto__=THREE.Object3D.prototype,ROS3D.SceneNode.prototype.updatePose=function(e){this.position.set(e.position.x,e.position.y,e.position.z),this.quaternion.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),this.updateMatrixWorld(!0)},ROS3D.SceneNode.prototype.unsubscribeTf=function(){this.tfClient.unsubscribe(this.frameID,this.tfUpdate)},ROS3D.Viewer=function(e){e=e||{};var t=e.divID,o=e.width,i=e.height,s=e.background||"#111111",r=e.antialias,n=e.intensity||.66,a=e.near||.01,c=e.far||1e3,h=e.alpha||1,l=e.cameraPose||{x:3,y:3,z:3},p=e.cameraZoomSpeed||.5;this.renderer=new THREE.WebGLRenderer({antialias:r,alpha:!0}),this.renderer.setClearColor(parseInt(s.replace("#","0x"),16),h),this.renderer.sortObjects=!1,this.renderer.setSize(o,i),this.renderer.shadowMapEnabled=!1,this.renderer.autoClear=!1,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(40,o/i,a,c),this.camera.position.x=l.x,this.camera.position.y=l.y,this.camera.position.z=l.z,this.cameraControls=new ROS3D.OrbitControls({scene:this.scene,camera:this.camera}),this.cameraControls.userZoomSpeed=p,this.scene.add(new THREE.AmbientLight(5592405)),this.directionalLight=new THREE.DirectionalLight(16777215,n),this.scene.add(this.directionalLight),this.selectableObjects=new THREE.Object3D,this.scene.add(this.selectableObjects);var d=new ROS3D.MouseHandler({renderer:this.renderer,camera:this.camera,rootObject:this.selectableObjects,fallbackTarget:this.cameraControls});this.highlighter=new ROS3D.Highlighter({mouseHandler:d}),this.stopped=!0,this.animationRequestId=void 0,document.getElementById(t).appendChild(this.renderer.domElement),this.start()},ROS3D.Viewer.prototype.start=function(){this.stopped=!1,this.draw()},ROS3D.Viewer.prototype.draw=function(){this.stopped||(this.cameraControls.update(),this.directionalLight.position=this.camera.localToWorld(new THREE.Vector3(-1,1,0)),this.directionalLight.position.normalize(),this.renderer.clear(!0,!0,!0),this.renderer.render(this.scene,this.camera),this.highlighter.renderHighlight(this.renderer,this.scene,this.camera),this.animationRequestId=requestAnimationFrame(this.draw.bind(this)))},ROS3D.Viewer.prototype.stop=function(){this.stopped||cancelAnimationFrame(this.animationRequestId),this.stopped=!0},ROS3D.Viewer.prototype.addObject=function(e,t){t?this.selectableObjects.add(e):this.scene.add(e)},ROS3D.Viewer.prototype.resize=function(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)},ROS3D.Highlighter=function(e){e=e||{},this.mouseHandler=e.mouseHandler,this.hoverObjs=[],this.mouseHandler.addEventListener("mouseover",this.onMouseOver.bind(this)),this.mouseHandler.addEventListener("mouseout",this.onMouseOut.bind(this))},ROS3D.Highlighter.prototype.onMouseOver=function(e){this.hoverObjs.push(e.currentTarget)},ROS3D.Highlighter.prototype.onMouseOut=function(e){this.hoverObjs.splice(this.hoverObjs.indexOf(e.currentTarget),1)},ROS3D.Highlighter.prototype.getWebglObjects=function(e,t,o){for(var i=e.__webglObjects,s=0;s<t.length;s++)if(t[s]){for(var r=i.length-1;r>=0;r--)if(i[r].object===t[s]){o.push(i[r]);break}this.getWebglObjects(e,t[s].children,o)}},ROS3D.Highlighter.prototype.renderHighlight=function(e,t,o){var i=[];this.getWebglObjects(t,this.hoverObjs,i),t.overrideMaterial=new THREE.MeshBasicMaterial({fog:!1,opacity:.5,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetUnits:-1,side:THREE.DoubleSide});var s=t.__webglObjects;t.__webglObjects=i,e.render(t,o),t.__webglObjects=s,t.overrideMaterial=null},ROS3D.MouseHandler=function(e){THREE.EventDispatcher.call(this),this.renderer=e.renderer,this.camera=e.camera,this.rootObject=e.rootObject,this.fallbackTarget=e.fallbackTarget,this.lastTarget=this.fallbackTarget,this.dragging=!1,this.projector=new THREE.Projector;var t=["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"];this.listeners={},t.forEach(function(e){this.listeners[e]=this.processDomEvent.bind(this),
this.renderer.domElement.addEventListener(e,this.listeners[e],!1)},this)},ROS3D.MouseHandler.prototype.processDomEvent=function(e){e.preventDefault();var t,o,i=e.target,s=i.getBoundingClientRect();if(-1!==e.type.indexOf("touch")){t=0,o=0;for(var r=0;r<e.touches.length;++r)t+=e.touches[r].clientX,o+=e.touches[r].clientY;t/=e.touches.length,o/=e.touches.length}else t=e.clientX,o=e.clientY;var n=t-s.left-i.clientLeft+i.scrollLeft,a=o-s.top-i.clientTop+i.scrollTop,c=n/i.clientWidth*2-1,h=-a/i.clientHeight*2+1,l=new THREE.Vector3(c,h,.5);this.projector.unprojectVector(l,this.camera);var p=new THREE.Raycaster(this.camera.position.clone(),l.sub(this.camera.position).normalize());p.linePrecision=.001;var d=p.ray,u={mousePos:new THREE.Vector2(c,h),mouseRay:d,domEvent:e,camera:this.camera,intersection:this.lastIntersection};if("mouseout"===e.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",u),this.dragging=!1),this.notify(this.lastTarget,"mouseout",u),void(this.lastTarget=null);if("touchleave"===e.type||"touchend"===e.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",u),this.dragging=!1),this.notify(this.lastTarget,"touchend",u),void(this.lastTarget=null);if(this.dragging)return this.notify(this.lastTarget,e.type,u),void(("mouseup"===e.type&&2===e.button||"click"===e.type||"touchend"===e.type)&&(this.dragging=!1));i=this.lastTarget;var E=[];if(E=p.intersectObject(this.rootObject,!0),E.length>0?(i=E[0].object,u.intersection=this.lastIntersection=E[0]):i=this.fallbackTarget,i!==this.lastTarget&&e.type.match(/mouse/)){this.notify(i,"mouseover",u)?this.notify(this.lastTarget,"mouseout",u):(i=this.fallbackTarget)!==this.lastTarget&&(this.notify(i,"mouseover",u),this.notify(this.lastTarget,"mouseout",u))}if(i!==this.lastTarget&&e.type.match(/touch/)){this.notify(i,e.type,u)?(this.notify(this.lastTarget,"touchleave",u),this.notify(this.lastTarget,"touchend",u)):(i=this.fallbackTarget)!==this.lastTarget&&(this.notify(this.lastTarget,"touchmove",u),this.notify(this.lastTarget,"touchend",u))}this.notify(i,e.type,u),"mousedown"!==e.type&&"touchstart"!==e.type&&"touchmove"!==e.type||(this.dragging=!0),this.lastTarget=i},ROS3D.MouseHandler.prototype.notify=function(e,t,o){for(o.type=t,o.cancelBubble=!1,o.stopPropagation=function(){o.cancelBubble=!0},o.currentTarget=e;o.currentTarget;){if(o.currentTarget.dispatchEvent&&o.currentTarget.dispatchEvent instanceof Function&&(o.currentTarget.dispatchEvent(o),o.cancelBubble))return this.dispatchEvent(o),!0;o.currentTarget=o.currentTarget.parent}return!1},THREE.EventDispatcher.prototype.apply(ROS3D.MouseHandler.prototype),ROS3D.OrbitControls=function(e){function t(e){var t=e.domEvent;switch(t.preventDefault(),t.button){case 0:w=D.ROTATE,u.set(t.clientX,t.clientY);break;case 1:w=D.MOVE,O=new THREE.Vector3(0,0,1);var o=(new THREE.Matrix4).extractRotation(this.camera.matrix);O.applyMatrix4(o),T=h.center.clone(),g=h.camera.position.clone(),b=i(e.mouseRay,T,O);break;case 2:w=D.ZOOM,m.set(t.clientX,t.clientY)}this.showAxes()}function o(e){var t=e.domEvent;if(w===D.ROTATE)E.set(t.clientX,t.clientY),R.subVectors(E,u),h.rotateLeft(2*Math.PI*R.x/p*h.userRotateSpeed),h.rotateUp(2*Math.PI*R.y/p*h.userRotateSpeed),u.copy(E),this.showAxes();else if(w===D.ZOOM)f.set(t.clientX,t.clientY),v.subVectors(f,m),v.y>0?h.zoomIn():h.zoomOut(),m.copy(f),this.showAxes();else if(w===D.MOVE){var o=i(e.mouseRay,h.center,O);if(!o)return;var s=(new THREE.Vector3).subVectors(b.clone(),o.clone());h.center.addVectors(T.clone(),s.clone()),h.camera.position.addVectors(g.clone(),s.clone()),h.update(),h.camera.updateMatrixWorld(),this.showAxes()}}function i(e,t,o){var i=new THREE.Vector3;new THREE.Vector3;i.subVectors(t,e.origin);var s=e.direction.dot(o);if(Math.abs(s)<e.precision)return null;var r=o.dot(i)/s;return e.direction.clone().multiplyScalar(r)}function s(e){h.userRotate&&(w=D.NONE)}function r(e){if(h.userZoom){var t,o=e.domEvent;t=void 0!==o.wheelDelta?o.wheelDelta:-o.detail,t>0?h.zoomIn():h.zoomOut(),this.showAxes()}}function n(e){var t=e.domEvent;switch(t.touches.length){case 1:w=D.ROTATE,u.set(t.touches[0].pageX-window.scrollX,t.touches[0].pageY-window.scrollY);break;case 2:w=D.NONE,O=new THREE.Vector3(0,0,1);var o=(new THREE.Matrix4).extractRotation(this.camera.matrix);O.applyMatrix4(o),T=h.center.clone(),g=h.camera.position.clone(),b=i(e.mouseRay,T,O),y[0]=new THREE.Vector2(t.touches[0].pageX,t.touches[0].pageY),y[1]=new THREE.Vector2(t.touches[1].pageX,t.touches[1].pageY),S[0]=new THREE.Vector2(0,0),S[1]=new THREE.Vector2(0,0)}this.showAxes(),t.preventDefault()}function a(e){var t=e.domEvent;if(w===D.ROTATE)E.set(t.touches[0].pageX-window.scrollX,t.touches[0].pageY-window.scrollY),R.subVectors(E,u),h.rotateLeft(2*Math.PI*R.x/p*h.userRotateSpeed),h.rotateUp(2*Math.PI*R.y/p*h.userRotateSpeed),u.copy(E),this.showAxes();else{if(S[0].set(y[0].x-t.touches[0].pageX,y[0].y-t.touches[0].pageY),S[1].set(y[1].x-t.touches[1].pageX,y[1].y-t.touches[1].pageY),S[0].lengthSq()>d&&S[1].lengthSq()>d&&(y[0].set(t.touches[0].pageX,t.touches[0].pageY),y[1].set(t.touches[1].pageX,t.touches[1].pageY),S[0].dot(S[1])>0&&w!==D.ZOOM?w=D.MOVE:S[0].dot(S[1])<0&&w!==D.MOVE&&(w=D.ZOOM),w===D.ZOOM)){var o=new THREE.Vector2;o.subVectors(y[0],y[1]),S[0].dot(o)<0&&S[1].dot(o)>0?h.zoomOut():S[0].dot(o)>0&&S[1].dot(o)<0&&h.zoomIn()}if(w===D.MOVE){var s=i(e.mouseRay,h.center,O);if(!s)return;var r=(new THREE.Vector3).subVectors(b.clone(),s.clone());h.center.addVectors(T.clone(),r.clone()),h.camera.position.addVectors(g.clone(),r.clone()),h.update(),h.camera.updateMatrixWorld()}this.showAxes(),t.preventDefault()}}function c(e){var t=e.domEvent;1===t.touches.length&&w!==D.ROTATE?(w=D.ROTATE,u.set(t.touches[0].pageX-window.scrollX,t.touches[0].pageY-window.scrollY)):w=D.NONE}THREE.EventDispatcher.call(this);var h=this;e=e||{};var l=e.scene;this.camera=e.camera,this.center=new THREE.Vector3,this.userZoom=!0,this.userZoomSpeed=e.userZoomSpeed||1,this.userRotate=!0,this.userRotateSpeed=e.userRotateSpeed||1,this.autoRotate=e.autoRotate,this.autoRotateSpeed=e.autoRotateSpeed||2,this.camera.up=new THREE.Vector3(0,0,1);var p=1800,d=10,u=new THREE.Vector2,E=new THREE.Vector2,R=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector2,v=new THREE.Vector2,T=new THREE.Vector3,O=new THREE.Vector3,g=new THREE.Vector3,b=new THREE.Vector3,y=new Array(2),S=new Array(2);this.phiDelta=0,this.thetaDelta=0,this.scale=1,this.lastPosition=new THREE.Vector3;var D={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2},w=D.NONE;this.axes=new ROS3D.Axes({shaftRadius:.025,headRadius:.07,headLength:.2}),l.add(this.axes),this.axes.traverse(function(e){e.visible=!1}),this.addEventListener("mousedown",t),this.addEventListener("mouseup",s),this.addEventListener("mousemove",o),this.addEventListener("touchstart",n),this.addEventListener("touchmove",a),this.addEventListener("touchend",c),this.addEventListener("mousewheel",r),this.addEventListener("DOMMouseScroll",r)},ROS3D.OrbitControls.prototype.showAxes=function(){var e=this;this.axes.traverse(function(e){e.visible=!0}),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(function(){e.axes.traverse(function(e){e.visible=!1}),e.hideTimeout=!1},1e3)},ROS3D.OrbitControls.prototype.rotateLeft=function(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta-=e},ROS3D.OrbitControls.prototype.rotateRight=function(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta+=e},ROS3D.OrbitControls.prototype.rotateUp=function(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta-=e},ROS3D.OrbitControls.prototype.rotateDown=function(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta+=e},ROS3D.OrbitControls.prototype.zoomIn=function(e){void 0===e&&(e=Math.pow(.95,this.userZoomSpeed)),this.scale/=e},ROS3D.OrbitControls.prototype.zoomOut=function(e){void 0===e&&(e=Math.pow(.95,this.userZoomSpeed)),this.scale*=e},ROS3D.OrbitControls.prototype.update=function(){var e=this.camera.position,t=e.clone().sub(this.center),o=Math.atan2(t.y,t.x),i=Math.atan2(Math.sqrt(t.y*t.y+t.x*t.x),t.z);this.autoRotate&&this.rotateLeft(2*Math.PI/60/60*this.autoRotateSpeed),o+=this.thetaDelta,i+=this.phiDelta;i=Math.max(1e-6,Math.min(Math.PI-1e-6,i));var s=t.length();t.y=s*Math.sin(i)*Math.sin(o),t.z=s*Math.cos(i),t.x=s*Math.sin(i)*Math.cos(o),t.multiplyScalar(this.scale),e.copy(this.center).add(t),this.camera.lookAt(this.center),s=t.length(),this.axes.position=this.center.clone(),this.axes.scale.x=this.axes.scale.y=this.axes.scale.z=.05*s,this.axes.updateMatrixWorld(!0),this.thetaDelta=0,this.phiDelta=0,this.scale=1,this.lastPosition.distanceTo(this.camera.position)>0&&(this.dispatchEvent({type:"change"}),this.lastPosition.copy(this.camera.position))},THREE.EventDispatcher.prototype.apply(ROS3D.OrbitControls.prototype);